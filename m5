<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ¸ Minna no Nihongo N5 â€” Offline Study App (1 file)</title>
  <style>
    :root{
      --bg: #f8fafc; /* slate-50 */
      --panel: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --muted: #64748b; /* slate-500 */
      --brand: #6366f1; /* indigo-500 */
      --brand-2: #22c55e; /* green-500 */
      --danger: #ef4444; /* red-500 */
      --warn: #f59e0b; /* amber-500 */
      --ok: #10b981; /* emerald-500 */
      --shadow: 0 10px 25px rgba(2,6,23,.08);
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Inter, Arial, "Noto Sans", sans-serif; color:var(--ink); background:linear-gradient(180deg,#eef2ff, #e0f2fe 70%);
      display:flex; flex-direction:column; min-height:100vh; overflow:hidden;
    }
    header{
      position:sticky; top:0; z-index:20; backdrop-filter: blur(10px);
      background:rgba(255,255,255,.6); border-bottom:1px solid rgba(255,255,255,.5);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 16px;
    }
    header .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    header .brand .title{font-size:18px}
    header .actions{display:flex; gap:8px}
    .btn{border:0; border-radius:14px; padding:8px 14px; cursor:pointer; background:var(--ink); color:#fff; box-shadow:var(--shadow)}
    .btn.ghost{background:transparent; color:var(--ink); border:1px solid rgba(15,23,42,.1)}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:12px}

    .wrap{display:grid; grid-template-columns: 260px 1fr; gap:16px; padding:16px; height:calc(100vh - 58px)}
    aside{
      height:100%; overflow:auto; background:rgba(255,255,255,.7); border:1px solid rgba(255,255,255,.8); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    main{
      height:100%; overflow:auto; background:rgba(255,255,255,.7); border:1px solid rgba(255,255,255,.8); border-radius:18px; box-shadow:var(--shadow);
      padding:16px; scroll-behavior:smooth;
    }
    .section{margin-bottom:18px}
    h2{font-size:18px; margin:0 0 10px 0}
    .card{background:var(--panel); border:1px solid rgba(2,6,23,.06); border-radius:18px; box-shadow:var(--shadow); padding:14px; margin-bottom:12px}
    .kpi{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
    .kpi .tile{background:var(--panel); padding:12px; border-radius:16px; text-align:center; border:1px solid rgba(2,6,23,.06); box-shadow:var(--shadow)}
    .kpi .big{font-weight:700; font-size:22px}
    .muted{color:var(--muted); font-size:12px}

    .menu-group{margin-bottom:8px}
    .menu-title{font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); margin:8px 6px}
    .menu button{display:block; width:100%; text-align:left; background:#fff; border:1px solid rgba(2,6,23,.06); box-shadow:var(--shadow); color:var(--ink); padding:8px 10px; margin:6px 0; border-radius:12px; cursor:pointer}
    .menu button.active{background:var(--brand); color:#fff}

    .list{display:grid; gap:8px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-radius:12px; background:var(--panel); border:1px solid rgba(2,6,23,.06)}
    .row .main{display:flex; flex-direction:column}
    .row .tag{font-size:12px; color:var(--muted)}

    .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid rgba(2,6,23,.08); background:#fff}

    .kana-grid{display:grid; grid-template-columns:repeat(10,minmax(0,1fr)); gap:6px}
    .kana{background:#fff; border:1px solid rgba(2,6,23,.06); border-radius:14px; padding:12px 6px; text-align:center; box-shadow:var(--shadow)}
    .kana .jp{font-size:26px; font-weight:800}
    .kana .ro{font-size:11px; color:var(--muted)}

    .quiz{display:grid; gap:8px}
    .quiz .q{font-size:18px; font-weight:700}
    .opt{display:block; width:100%; text-align:left; background:#fff; border:1px solid rgba(2,6,23,.08); border-radius:12px; padding:10px; cursor:pointer}
    .opt.correct{background:#dcfce7; border-color:#86efac}
    .opt.wrong{background:#fee2e2; border-color:#fecaca}

    .bar{height:8px; background:#e2e8f0; border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; background:linear-gradient(90deg, var(--brand), #22d3ee)}

    summary{cursor:pointer; font-weight:700}
    details{background:#fff; border:1px solid rgba(2,6,23,.06); border-radius:12px; padding:10px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    input[type="search"], input[type="text"]{padding:8px 10px; border-radius:10px; border:1px solid rgba(2,6,23,.12); width:100%}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span style="font-size:22px">ğŸŒ¸</span>
      <div class="title">Minna no Nihongo N5 â€” Offline</div>
      <span class="pill" id="streakPill">Streak: 0ğŸ”¥</span>
    </div>
    <div class="actions">
      <button class="btn ghost small" id="btnExport">Export tiáº¿n Ä‘á»™</button>
      <button class="btn ghost small" id="btnImport">Import tiáº¿n Ä‘á»™</button>
      <button class="btn small" id="btnToggleTheme">Cháº¿ Ä‘á»™ tá»‘i</button>
    </div>
  </header>

  <div class="wrap">
    <aside>
      <div class="menu">
        <div class="menu-group">
          <div class="menu-title">Tá»•ng quan</div>
          <button data-route="overview" class="active">ğŸ“Š Tá»•ng quan</button>
          <button data-route="kana">ã‚/ã‚¢ Báº£ng chá»¯</button>
          <button data-route="review">ğŸ§  Ã”n táº­p nhanh</button>
        </div>
        <div class="menu-group">
          <div class="menu-title">BÃ i há»c (L1â€“L25)</div>
          <div id="lessonList"></div>
        </div>
      </div>
    </aside>

    <main id="app">
      <!-- ná»™i dung Ä‘á»™ng -->
    </main>
  </div>

  <input type="file" id="fileInput" accept="application/json" hidden />

  <script>
  // ============================
  // Utils & Storage
  // ============================
  const $ = (sel, el=document)=> el.querySelector(sel);
  const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));
  const store = {
    get(k, v){ try{ return JSON.parse(localStorage.getItem(k)) ?? v }catch{ return v } },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} },
  };
  const todayKey = ()=> new Date().toISOString().slice(0,10);

  function speakJa(text){
    try{ const u = new SpeechSynthesisUtterance(text); u.lang='ja-JP'; speechSynthesis.speak(u);}catch{}
  }

  function shuffle(a){ a=[...a]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  // ============================
  // Minimal datasets (L1â€“L3 máº«u). Báº¡n cÃ³ thá»ƒ má»Ÿ rá»™ng dáº§n tá»›i L25 theo cÃ¹ng cáº¥u trÃºc.
  // ============================
  const LESSONS = {
    1: {
      vocab: [
        {jp:'ã‚ãŸã—',kana:'ã‚ãŸã—',romaji:'watashi',vi:'tÃ´i'},
        {jp:'ã‚ãªãŸ',kana:'ã‚ãªãŸ',romaji:'anata',vi:'báº¡n'},
        {jp:'å­¦ç”Ÿ',kana:'ãŒãã›ã„',romaji:'gakusei',vi:'há»c sinh, sinh viÃªn'},
        {jp:'å…ˆç”Ÿ',kana:'ã›ã‚“ã›ã„',romaji:'sensei',vi:'giÃ¡o viÃªn'},
        {jp:'ä¼šç¤¾å“¡',kana:'ã‹ã„ã—ã‚ƒã„ã‚“',romaji:'kaishain',vi:'nhÃ¢n viÃªn cÃ´ng ty'},
      ],
      grammar: [
        { title:'A ã¯ B ã§ã™', note:'A lÃ  B (lá»‹ch sá»±).', examples:[
          {jp:'ã‚ãŸã—ã¯ å­¦ç”Ÿã§ã™ã€‚',romaji:'watashi wa gakusei desu.',vi:'TÃ´i lÃ  há»c sinh.'},
          {jp:'ãŸãªã‹ã•ã‚“ã¯ å…ˆç”Ÿã§ã™ã€‚',romaji:'Tanaka-san wa sensei desu.',vi:'Anh Tanaka lÃ  giÃ¡o viÃªn.'}
        ]},
        { title:'A ã¯ B ã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“', note:'A khÃ´ng pháº£i B (phá»§ Ä‘á»‹nh).', examples:[
          {jp:'ã‚ãŸã—ã¯ å…ˆç”Ÿã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚',romaji:'watashi wa sensei jaarimasen.',vi:'TÃ´i khÃ´ng pháº£i giÃ¡o viÃªn.'}
        ]},
        { title:'A ã¯ B ã§ã™ã‹', note:'A cÃ³ pháº£i B khÃ´ng? (nghi váº¥n).', examples:[
          {jp:'ã‚ãªãŸã¯ å­¦ç”Ÿã§ã™ã‹ã€‚',romaji:'anata wa gakusei desu ka?',vi:'Báº¡n lÃ  há»c sinh Ã ?'}
        ]}
      ],
      quiz:[
        {q:'ã‚ãŸã— ___ å­¦ç”Ÿã§ã™ã€‚', options:['ã¯','ãŒ','ã‚’'], answer:'ã¯', explain:'Chá»§ Ä‘á»: ã‚ãŸã— ã¯ ...'},
        {q:'ãŸãªã‹ã•ã‚“ ___ å…ˆç”Ÿã§ã™ã‹ã€‚', options:['ã¯','ãŒ','ã‚’'], answer:'ã¯', explain:'CÃ¢u há»i vá»›i ã¯.'},
        {q:'ã‚ãŸã—ã¯ å…ˆç”Ÿ ___ ã‚ã‚Šã¾ã›ã‚“ã€‚', options:['ã˜ã‚ƒ','ã§','ã‚’'], answer:'ã˜ã‚ƒ', explain:'Phá»§ Ä‘á»‹nh ã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚'}
      ]
    },
    2: {
      vocab:[
        {jp:'ã“ã‚Œ',kana:'ã“ã‚Œ',romaji:'kore',vi:'cÃ¡i nÃ y'},
        {jp:'ãã‚Œ',kana:'ãã‚Œ',romaji:'sore',vi:'cÃ¡i Ä‘Ã³'},
        {jp:'ã‚ã‚Œ',kana:'ã‚ã‚Œ',romaji:'are',vi:'cÃ¡i kia'},
        {jp:'ã“ã®',kana:'ã“ã®',romaji:'kono',vi:'~ nÃ y'},
        {jp:'ãã®',kana:'ãã®',romaji:'sono',vi:'~ Ä‘Ã³'},
        {jp:'ã‚ã®',kana:'ã‚ã®',romaji:'ano',vi:'~ kia'},
      ],
      grammar:[
        {title:'ã“ã‚Œï¼ãã‚Œï¼ã‚ã‚Œ', note:'Chá»‰ thá»‹ váº­t theo khoáº£ng cÃ¡ch.', examples:[
          {jp:'ã“ã‚Œã¯ ãªã‚“ã§ã™ã‹ã€‚',romaji:'kore wa nan desu ka?',vi:'CÃ¡i nÃ y lÃ  gÃ¬?'},
        ]},
        {title:'ã“ã®Nï¼ãã®Nï¼ã‚ã®N', note:'Danh tá»« + chá»‰ thá»‹.', examples:[
          {jp:'ã“ã® ã»ã‚“ã¯ ã‚ãŸã—ã® ã§ã™ã€‚',romaji:'kono hon wa watashi no desu.',vi:'Cuá»‘n sÃ¡ch nÃ y lÃ  cá»§a tÃ´i.'}
        ]}
      ],
      quiz:[
        {q:'___ ã¯ ãªã‚“ã§ã™ã‹ã€‚ (gáº§n ngÆ°á»i nÃ³i)', options:['ã“ã‚Œ','ãã‚Œ','ã‚ã‚Œ'], answer:'ã“ã‚Œ', explain:'Gáº§n ngÆ°á»i nÃ³i â†’ ã“ã‚Œ'},
        {q:'___ ã»ã‚“ã¯ ã‚ãªãŸã® ã§ã™ã‹ã€‚ (~ Ä‘Ã³)', options:['ã“ã®','ãã®','ã‚ã®'], answer:'ãã®', explain:'Gáº§n ngÆ°á»i nghe â†’ ãã®'}
      ]
    },
    3: {
      vocab:[
        {jp:'ã“ã“',kana:'ã“ã“',romaji:'koko',vi:'á»Ÿ Ä‘Ã¢y'},
        {jp:'ãã“',kana:'ãã“',romaji:'soko',vi:'á»Ÿ Ä‘Ã³'},
        {jp:'ã‚ãã“',kana:'ã‚ãã“',romaji:'asoko',vi:'á»Ÿ kia'},
        {jp:'ã©ã“',kana:'ã©ã“',romaji:'doko',vi:'á»Ÿ Ä‘Ã¢u'},
      ],
      grammar:[
        {title:'ã“ã“ï¼ãã“ï¼ã‚ãã“ï¼ã©ã“', note:'Chá»‰ Ä‘á»‹a Ä‘iá»ƒm.', examples:[
          {jp:'ãƒˆã‚¤ãƒ¬ã¯ ã©ã“ã§ã™ã‹ã€‚',romaji:'toire wa doko desu ka?',vi:'NhÃ  vá»‡ sinh á»Ÿ Ä‘Ã¢u?'}
        ]}
      ],
      quiz:[
        {q:'ãˆãã¯ ___ ã§ã™ã‹ã€‚ (ga tÃ u)', options:['ã©ã“','ã“ã“','ãã“'], answer:'ã©ã“', explain:'Há»i nÆ¡i chá»‘n â†’ ã©ã“'},
      ]
    }
    // ğŸ‘‰ Báº¡n cÃ³ thá»ƒ bá»• sung dáº§n Ä‘áº¿n 25 theo cÃ¹ng format.
  };

  // Hiragana/Katakana cÆ¡ báº£n (gojÅ«on)
  const HIRAGANA = [
    ['ã‚','a'],['ã„','i'],['ã†','u'],['ãˆ','e'],['ãŠ','o'],
    ['ã‹','ka'],['ã','ki'],['ã','ku'],['ã‘','ke'],['ã“','ko'],
    ['ã•','sa'],['ã—','shi'],['ã™','su'],['ã›','se'],['ã','so'],
    ['ãŸ','ta'],['ã¡','chi'],['ã¤','tsu'],['ã¦','te'],['ã¨','to'],
    ['ãª','na'],['ã«','ni'],['ã¬','nu'],['ã­','ne'],['ã®','no'],
    ['ã¯','ha'],['ã²','hi'],['ãµ','fu'],['ã¸','he'],['ã»','ho'],
    ['ã¾','ma'],['ã¿','mi'],['ã‚€','mu'],['ã‚','me'],['ã‚‚','mo'],
    ['ã‚„','ya'],['ã‚†','yu'],['ã‚ˆ','yo'],
    ['ã‚‰','ra'],['ã‚Š','ri'],['ã‚‹','ru'],['ã‚Œ','re'],['ã‚','ro'],
    ['ã‚','wa'],['ã‚’','wo'],['ã‚“','n']
  ];
  const KATAKANA = [
    ['ã‚¢','a'],['ã‚¤','i'],['ã‚¦','u'],['ã‚¨','e'],['ã‚ª','o'],
    ['ã‚«','ka'],['ã‚­','ki'],['ã‚¯','ku'],['ã‚±','ke'],['ã‚³','ko'],
    ['ã‚µ','sa'],['ã‚·','shi'],['ã‚¹','su'],['ã‚»','se'],['ã‚½','so'],
    ['ã‚¿','ta'],['ãƒ','chi'],['ãƒ„','tsu'],['ãƒ†','te'],['ãƒˆ','to'],
    ['ãƒŠ','na'],['ãƒ‹','ni'],['ãƒŒ','nu'],['ãƒ','ne'],['ãƒ','no'],
    ['ãƒ','ha'],['ãƒ’','hi'],['ãƒ•','fu'],['ãƒ˜','he'],['ãƒ›','ho'],
    ['ãƒ','ma'],['ãƒŸ','mi'],['ãƒ ','mu'],['ãƒ¡','me'],['ãƒ¢','mo'],
    ['ãƒ¤','ya'],['ãƒ¦','yu'],['ãƒ¨','yo'],
    ['ãƒ©','ra'],['ãƒª','ri'],['ãƒ«','ru'],['ãƒ¬','re'],['ãƒ­','ro'],
    ['ãƒ¯','wa'],['ãƒ²','wo'],['ãƒ³','n']
  ];

  // ============================
  // Progress / Streak
  // ============================
  function bumpStreak(){
    const key='streak'; const rec=store.get(key,{last:"", count:0});
    const today=todayKey();
    if(rec.last===today) return rec.count;
    const yesterday=new Date(Date.now()-86400000).toISOString().slice(0,10);
    const next = { last: today, count: rec.last===yesterday? rec.count+1 : 1 };
    store.set(key,next); return next.count;
  }
  function readStreak(){ const rec=store.get('streak',{last:"",count:0}); return rec.count }

  // ============================
  // Rendering
  // ============================
  const app = document.getElementById('app');
  const lessonListEl = document.getElementById('lessonList');

  function renderLessonList(){
    const total=25; let html='';
    for(let i=1;i<=total;i++){
      html += `<button data-route="lesson" data-lesson="${i}">BÃ i ${i}</button>`;
    }
    lessonListEl.innerHTML = html;
    // delegate
    lessonListEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-route]'); if(!btn) return;
      setActive(btn);
      const n = +btn.dataset.lesson; showLesson(n);
    });
  }

  function setActive(btn){
    $$('.menu button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  }

  function showOverview(){
    $('#app').innerHTML = `
      <div class="section">
        <div class="kpi">
          <div class="tile"><div class="muted">BÃ i Ä‘Ã£ cÃ³ dá»¯ liá»‡u</div><div class="big">${Object.keys(LESSONS).length}/25</div></div>
          <div class="tile"><div class="muted">Tá»« vá»±ng máº«u</div><div class="big">${Object.values(LESSONS).reduce((s,l)=>s+(l.vocab?.length||0),0)}</div></div>
          <div class="tile"><div class="muted">CÃ¢u há»i quiz</div><div class="big">${Object.values(LESSONS).reduce((s,l)=>s+(l.quiz?.length||0),0)}</div></div>
          <div class="tile"><div class="muted">Streak</div><div class="big">${readStreak()}ğŸ”¥</div></div>
        </div>
      </div>
      <div class="card">
        <h2>Báº¯t Ä‘áº§u há»c</h2>
        <div class="list">
          <div class="row"><div class="main"><b>LÃ m quiz nhanh (L1â†’L3)</b><span class="tag">Chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng, cÃ³ giáº£i thÃ­ch ngáº¯n</span></div><button class="btn small" id="btnQuickQuiz">LÃ m ngay</button></div>
          <div class="row"><div class="main"><b>Ã”n báº£ng chá»¯ (Hiragana/Katakana)</b><span class="tag">Báº¥m chá»¯ Ä‘á»ƒ nghe (náº¿u trÃ¬nh duyá»‡t há»— trá»£)</span></div><button class="btn small" data-route="kana">Má»Ÿ</button></div>
        </div>
      </div>
    `;
    $('#btnQuickQuiz')?.addEventListener('click', ()=> showReview());
  }

  function showKana(){
    const tile = ([k,r])=>`<div class="kana" onclick="speakJa('${k}')"><div class="jp">${k}</div><div class="ro">${r}</div></div>`;
    app.innerHTML = `
      <div class="card"><h2>Hiragana</h2><div class="kana-grid">${HIRAGANA.map(tile).join('')}</div></div>
      <div class="card"><h2>Katakana</h2><div class="kana-grid">${KATAKANA.map(tile).join('')}</div></div>
      <div class="card"><h2>Luyá»‡n gÃµ romaji</h2>
        <div class="toolbar">
          <input id="typeInput" type="text" placeholder="GÃµ romaji cho kÃ½ tá»± hiá»ƒn thá»‹..." />
          <span class="pill" id="typeStats">ÄÃºng 0 â€¢ Sai 0</span>
        </div>
        <div style="font-size:48px; font-weight:800; margin-top:10px" id="typeChar">ã‚</div>
      </div>
    `;
    initTypingPractice();
  }

  function initTypingPractice(){
    const pool = shuffle([...HIRAGANA]);
    let i=0, correct=0, wrong=0;
    const charEl = $('#typeChar');
    const input = $('#typeInput');
    const stats = $('#typeStats');
    function next(){ const [k,r]=pool[i%pool.length]; charEl.textContent=k; input.value=''; input.focus(); }
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const [k,r]=pool[i%pool.length]; const ans=input.value.trim().toLowerCase(); if(ans===r){correct++} else {wrong++} i++; stats.textContent=`ÄÃºng ${correct} â€¢ Sai ${wrong}`; next(); }})
    next();
  }

  function showLesson(n){
    bumpStreak(); updateStreakPill();
    const L = LESSONS[n];
    if(!L){ app.innerHTML = `<div class="card"><h2>BÃ i ${n}</h2><div class="muted">ChÆ°a cÃ³ dá»¯ liá»‡u cho bÃ i nÃ y.</div></div>`; return; }
    const vocab = (L.vocab||[]).map(v=>`
      <div class="row">
        <div class="main"><b>${v.jp}</b><span class="tag">${v.kana||''} â€¢ ${v.romaji||''}</span><div>${v.vi||''}</div></div>
        <button class="btn small" onclick="speakJa('${v.kana||v.jp}')">ğŸ”Š Nghe</button>
      </div>`).join('');

    const grammar = (L.grammar||[]).map(g=>`
      <details><summary>${g.title}</summary><div class="muted" style="margin:6px 0">${g.note||''}</div>${(g.examples||[]).map(ex=>`<div class="row"><div class="main"><b>${ex.jp}</b><span class="tag">${ex.romaji||''}</span><div>${ex.vi||''}</div></div><button class="btn small" onclick="speakJa('${ex.jp}')">ğŸ”Š</button></div>`).join('')}</details>
    `).join('');

    const quiz = (L.quiz||[]).map((it,idx)=>`
      <div class="card">
        <div class="q">${it.q}</div>
        <div class="quiz">${it.options.map(op=>`<button class="opt" data-lesson="${n}" data-idx="${idx}" data-op="${op}">${op}</button>`).join('')}</div>
        <div class="muted" style="margin-top:8px">${it.explain? 'Gá»£i Ã½: '+it.explain: ''}</div>
      </div>`).join('');

    app.innerHTML = `
      <div class="card"><h2>BÃ i ${n} â€” Tá»« vá»±ng</h2><div class="list">${vocab||'<div class="muted">(Äang cáº­p nháº­t)</div>'}</div></div>
      <div class="card"><h2>Ngá»¯ phÃ¡p</h2><div class="list">${grammar||'<div class="muted">(Äang cáº­p nháº­t)</div>'}</div></div>
      <div class="card"><h2>Quiz</h2>${quiz || '<div class="muted">(ChÆ°a cÃ³ cÃ¢u há»i)</div>'}</div>
    `;

    // handle quiz clicks
    $$('#app .opt').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const lesson=+btn.dataset.lesson; const idx=+btn.dataset.idx; const op=btn.dataset.op;
        const item = LESSONS[lesson].quiz[idx];
        const ok = item.answer===op;
        $$('#app .opt').filter(b=>b.dataset.idx===String(idx)).forEach(b=>b.disabled=true);
        btn.classList.add(ok? 'correct':'wrong');
        // save progress
        const key = `progress:L${lesson}`; const rec = store.get(key,{done:0, correct:0, total:0});
        rec.total = (rec.total||0)+1; rec.correct = (rec.correct||0) + (ok?1:0); rec.done = Date.now();
        store.set(key, rec);
      })
    })
  }

  function showReview(){
    // Gather a mixed set from available lessons
    const pool = Object.entries(LESSONS).flatMap(([ln,L])=> (L.quiz||[]).map((q,i)=>({ln:+ln, idx:i, ...q})) );
    const qs = shuffle(pool).slice(0,10);
    if(!qs.length){ app.innerHTML = '<div class="card">ChÆ°a cÃ³ cÃ¢u há»i Ä‘á»ƒ Ã´n.</div>'; return }

    let cur=0, score=0;
    function render(){
      const it = qs[cur];
      app.innerHTML = `
        <div class="card"><div class="muted">CÃ¢u ${cur+1}/${qs.length} â€¢ Äiá»ƒm: ${score}</div>
        <div class="q" style="margin:8px 0 12px 0">${it.q}</div>
        ${it.options.map(op=>`<button class="opt" data-op="${op}">${op}</button>`).join('')}
        <div class="muted" style="margin-top:8px">${it.explain? 'Gá»£i Ã½: '+it.explain: ''}</div>
        <div style="margin-top:12px" class="bar"><i style="width:${(cur/qs.length)*100}%"></i></div>
        </div>`;
      $$('#app .opt').forEach(b=> b.addEventListener('click', ()=>{
        const ok = b.dataset.op===it.answer; b.classList.add(ok? 'correct':'wrong');
        if(ok) score++;
        setTimeout(()=>{ cur++; if(cur<qs.length) render(); else showReviewResult(score, qs.length); }, 500);
      }))
    }
    render();
  }
  function showReviewResult(score,total){
    app.innerHTML = `<div class="card"><h2>Káº¿t quáº£</h2><p>Báº¡n Ä‘áº¡t <b>${score}/${total}</b>.</p><button class="btn" id="again">LÃ m láº¡i</button></div>`;
    $('#again').addEventListener('click', showReview);
  }

  // ============================
  // Theme + Export/Import
  // ============================
  function updateStreakPill(){ $('#streakPill').textContent = `Streak: ${readStreak()}ğŸ”¥`; }
  function toggleTheme(){ const dark = document.body.dataset.theme==='dark'; document.body.dataset.theme = dark? '' : 'dark'; }
  $('#btnToggleTheme').addEventListener('click', toggleTheme);

  $('#btnExport').addEventListener('click', ()=>{
    const data = {};
    Object.keys(localStorage).forEach(k=>{ if(k.startsWith('progress:') || k==='streak') data[k]=store.get(k); });
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='minna-n5-progress.json'; a.click(); URL.revokeObjectURL(url);
  });

  $('#btnImport').addEventListener('click', ()=> $('#fileInput').click());
  $('#fileInput').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{
      try{ const obj=JSON.parse(fr.result);
        Object.entries(obj).forEach(([k,v])=> localStorage.setItem(k, JSON.stringify(v)) );
        alert('ÄÃ£ import tiáº¿n Ä‘á»™.'); updateStreakPill();
      }catch(err){ alert('File khÃ´ng há»£p lá»‡.'); }
    }; fr.readAsText(file);
  });

  // ============================
  // Router (menu)
  // ============================
  function initMenu(){
    // top buttons
    $$('aside .menu [data-route]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        setActive(btn);
        const r = btn.dataset.route;
        if(r==='overview') showOverview();
        if(r==='kana') showKana();
        if(r==='review') showReview();
      });
    });
  }

  // Startup
  renderLessonList(); initMenu(); showOverview(); updateStreakPill(); bumpStreak(); updateStreakPill();
  </script>
</body>
</html>
